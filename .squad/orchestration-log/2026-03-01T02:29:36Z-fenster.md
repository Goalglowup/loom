# Fenster — Orchestration Log

**Timestamp:** 2026-03-01T02:29:36Z  
**Agent:** Fenster (Backend)  
**Task:** Fix 13 critical gaps + migrate 20+ portal routes

## Summary

Implemented all 13 must-fix domain service gaps identified by Keaton's audit. Successfully migrated 20+ portal routes from PortalService to domain services (UserManagementService, TenantManagementService). Slimmed PortalService from 993 → 392 lines.

## Changes

### Domain Service Enhancements

**UserManagementService (6 gaps fixed + 2 new methods)**
- Added email uniqueness 409 pre-check in `createUser()`
- Applied tenant name trimming in `createUser()`
- **Default agent creation** after tenant creation (critical for API key flow)
- Active tenant filtering in `login()` method
- Multi-tenant list in login response (`tenants: [{id, name, role}]`)
- No active tenants guard (403 if zero active memberships)
- New: `switchTenant(userId, newTenantId)` with full context
- New: `leaveTenant(userId, tenantId, currentTenantId)` with last-owner protection

**TenantManagementService (7 gaps fixed + 3 new methods)**
- Cache invalidation in `revokeApiKey()` — returns `keyHash` for cache eviction
- Provider cache eviction in `updateSettings()` when config changes
- Creator membership in `createSubtenant()` (prevents orphaned subtenants)
- New: `revokeInvite(tenantId, inviteId)` 
- New: `listInvites(tenantId)` with `revokedAt` field
- New: `updateMemberRole(tenantId, targetUserId, role)` with last-owner protection
- New: `removeMember(tenantId, targetUserId, requestingUserId)` with self-removal guard

**DTO Updates**
- `AuthResult`: added `tenants?: Array<{id, name, role}>`
- `CreateSubtenantDto`: added `createdByUserId`
- `InviteViewModel`: added `revokedAt`

### Route Migrations (20+ routes)

**Auth Routes (5 → UserManagementService)**
- POST /v1/portal/auth/signup
- POST /v1/portal/auth/login
- POST /v1/portal/auth/signup-with-invite
- POST /v1/portal/auth/switch-tenant (new)
- POST /v1/portal/tenants/:tenantId/leave (new)

**API Keys (3 → TenantManagementService)**
- GET/POST/DELETE /v1/portal/api-keys

**Agents (3 → TenantManagementService)**
- POST/PUT/DELETE /v1/portal/agents

**Members (3 → TenantManagementService)**
- GET/PATCH/DELETE /v1/portal/members

**Invites (3 → TenantManagementService)**
- POST/GET/DELETE /v1/portal/invites

**Other (3)**
- POST /v1/portal/subtenants
- PATCH /v1/portal/settings

### Test Results

- TypeScript compilation clean (`npx tsc --noEmit`)
- **All 355 tests passing**
- No breaking changes to existing method signatures
- Tests updated for mock changes (4 persist calls in `createUser`)

### PortalService Code Reduction

- Before: 993 lines
- After: 392 lines (~60% reduction)
- Removed: signup, login, switch-tenant, API key ops, member ops, invite ops, subtenant ops

## Technical Notes

- Error pattern: `throw Object.assign(new Error('message'), { status: 409 })`
- Domain services return camelCase; routes transform to match API contracts
- Last-owner protection: all member removal/demotion methods count owners before proceeding
- Cache eviction: `evictProvider` imported from `../../providers/registry.js`

## Routes Still on PortalService

- Agent list/get/resolved (pending migration)
- `GET /v1/portal/me` (pending migration)
- Traces, analytics (stay on PortalService)
- Conversations/partitions (stay on ConversationManagementService)

## Deliverables

1. **Decision:** `.squad/decisions/inbox/fenster-domain-service-gaps.md` — implementation details
2. **Decision:** `.squad/decisions/inbox/fenster-portal-migration.md` — phase completion summary
3. **Code:** All changes to domain services and portal routes

---

**Status:** ✅ Complete — 13 gaps fixed, 20+ routes migrated, 392-line PortalService, 355 tests passing
