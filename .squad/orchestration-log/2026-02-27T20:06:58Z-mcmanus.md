# Orchestration: McManus — Subtenants & Agents UI, Portal Updates

**Session:** 2026-02-27  
**Agent:** McManus (Frontend Dev)  
**Status:** ✅ Complete

## Tasks Completed

### 1. SubtenantsPage + AgentsPage + AgentEditor
- **Files:** `portal/src/pages/SubtenantsPage.tsx`, `portal/src/pages/AgentsPage.tsx`, `portal/src/components/AgentEditor.tsx`
- **Changes:**
  - SubtenantsPage: table showing id, name, status; create button for new subtenants
  - AgentsPage: table showing agents (id, name, provider, hasApiKey); inline AgentEditor panel
  - AgentEditor: discriminated union state (closed | create | edit); forms for agent name, provider_config, system_prompt, skills, mcp_endpoints
  - Resolved config displayed on expand (fetched lazily via `getResolvedAgentConfig`)
  - Navigation: Subtenants link only shows for owner role; Agents visible to all
  - Sidebar nav updated; route `/app/subtenants`, `/app/agents` added
- **Key Decisions:**
  - Inline editor panel (not modal or route) for simpler state management
  - EditorState as discriminated union for type safety
  - Subtenants owner-gated, Agents visible to all
  - Resolved config lazy-loaded on expand (avoids extra API call)
  - All API interfaces in `portal/src/lib/api.ts` (single source of truth)

### 2. ApiKeysPage + AnalyticsPage + SettingsPage Updates
- **Files:** `portal/src/pages/ApiKeysPage.tsx`, `portal/src/pages/AnalyticsPage.tsx`, `portal/src/pages/SettingsPage.tsx`
- **Changes:**
  - **ApiKeysPage:**
    - Agent selector dropdown (required field) in create form
    - Agents fetched on page load via `GET /v1/portal/agents`
    - Disabled create button if no agents exist (with message)
    - "Agent" column added to keys table
    - `createApiKey` call body updated: `{ name, agentId }`
    - `ApiKeyEntry` interface: `agentId?`, `agentName?` optional fields
  - **AnalyticsPage:**
    - New "Scope" dropdown: "All — roll up subtenants + agents" (default, `rollup=true`) vs. "This org only"
    - All three fetch calls append `?rollup=true` when selected
    - `key` prop on SharedAnalyticsPage changed on toggle (forces remount + re-fetch)
  - **SettingsPage:**
    - Title: "Provider settings" → "Org Defaults"
    - Subtitle: "Default settings inherited by agents. Agents can override these or leave them blank to use these values."
    - Note added: "These settings are inherited by all agents in this org unless the agent defines its own."
- **Key Decisions:**
  - Agent dropdown required for API key creation
  - Rollup scope toggle uses component remount strategy (avoids internal patch)
  - Agent name in keys table resolves client-side if absent from API

## Testing

- Smoke tests updated (see Hockney's batch)
- Form validation: agent required on API key create
- Page navigation: scope toggle re-fetches analytics correctly
- Sidebar nav: owner/non-owner role-based visibility works

## Commit

Committed: `63f2029` — "feat: subtenant hierarchy, agents, and project-scoped API keys"

---

## Learnings for Team

- **Discriminated unions:** More type-safe and ergonomic than nullable state + boolean flags
- **Role-gated nav:** Different users see different nav structure based on role (owner vs. member)
- **Component remount:** Changing a `key` prop forces React to remount (useful for lifecycle reset)
- **API type consolidation:** Single `api.ts` file for all interfaces; easier to maintain contracts
