# Orchestration Log: Fenster (Backend Dev)

**Date:** 2026-02-26T15:57:42Z  
**Agent:** Fenster  
**Task:** Tenant Portal Backend Implementation  
**Status:** ✅ Complete  
**Mode:** Background

---

## Tasks Completed

### Migration: `1000000000010_create-tenant-users.cjs`
- New `tenant_users` table: `id (UUID), tenant_id (FK → tenants CASCADE), email (unique), password_hash, role (varchar 50), created_at, last_login`
- Indexes on `tenant_id` and `email`
- Supports future RBAC; first user seeded as 'owner'

### Portal Auth Middleware: `src/middleware/portalAuth.ts`
- `registerPortalAuthMiddleware(fastify, requiredRole?)` Fastify preHandler
- Reads Bearer token from Authorization header
- Calls `request.portalJwtVerify()` (separate from admin JWT)
- Attaches `request.portalUser: { userId, tenantId, role }`
- Optional role enforcement (owner/member); returns 403 if mismatch

### Portal Routes: `src/routes/portal.ts`
- `POST /v1/portal/auth/signup` — atomic transaction: tenant + user + api_key; returns JWT + raw API key (shown once)
- `POST /v1/portal/auth/login` — scrypt password verify; 403 for suspended tenants
- `GET /v1/portal/me` — returns user + tenant (never raw LLM API key, only `hasApiKey: boolean`)
- `PATCH /v1/portal/settings` — owner only; encrypts LLM provider key via `encryptTraceBody`; evicts provider cache
- `GET /v1/portal/api-keys` — lists all keys for tenant (no raw keys)
- `POST /v1/portal/api-keys` — owner only; generates new `loom_sk_` key
- `DELETE /v1/portal/api-keys/:id` — owner only; soft revoke + LRU cache invalidation

### Integration: `src/index.ts`
- Registered portal JWT plugin (`namespace: 'portal', decoratorName: 'portalJwt'`)
- Registered `fastifyStatic` for `portal/dist/` at `/` with `decorateReply: false`
- Registered portal routes
- Added `PORTAL_JWT_SECRET` startup warning
- Updated `setNotFoundHandler` with portal SPA fallback logic

### Auth Skip List: `src/auth.ts`
- Added `/v1/portal` and non-`/v1/` routes to skip list (portal uses JWT, not tenant API key auth)

### Environment: `.env`
- Generated `PORTAL_JWT_SECRET` (32 bytes hex)

---

## Build & Test Results

```
npm run build → zero TypeScript errors
npm test → 113/113 tests pass
```

---

## Key Design Decisions

1. **Email lowercase enforcement** — Applied at application layer to prevent case-sensitivity issues
2. **Key prefix = 15 chars** — Follows spec's explicit instruction (`loom_sk_` + 7 base64url chars)
3. **Scrypt password format** — `salt:derivedKey` (matches `admin_users` pattern)
4. **JWT isolation** — Portal JWT fully separate from admin JWT via Fastify namespace
5. **SPA fallback routing** — Updated `setNotFoundHandler` to check `/v1/` and `/dashboard` before falling through to portal

---

## Items for Review

- **Rate limiting:** TODO comments added in signup/login endpoints (not blocking v1 but address before public launch)
- **`portal/dist/` gitignore:** Verify `.gitignore` covers this before commit
- **`docker-compose.yml`:** Add `PORTAL_JWT_SECRET` env var (not in scope for this task)

---

## Cross-Team Coordination

- **With McManus:** Frontend portal SPA now has complete API surface to consume (all 7 endpoints)
- **With Hockney:** Integration tests validate all endpoints, encryption, cache behavior, and transaction atomicity
