# Orchestration: Fenster — Subtenant Hierarchy, Agents, Analytics Rollup, Gateway Integration

**Session:** 2026-02-27  
**Agent:** Fenster (Backend Dev)  
**Status:** ✅ Complete

## Tasks Completed

### 1. Migration: Subtenant Hierarchy + Agents
- **File:** `migrations/1000000000012_subtenant-hierarchy-and-agents.cjs`
- **Changes:**
  - Added `parent_id` (self-FK) to `tenants` with ON DELETE CASCADE
  - Created `agents` table with `id, tenant_id, name, provider_config, system_prompt, skills, mcp_endpoints, merge_policies, created_at, updated_at`
  - Added `agent_id` (NOT NULL after seed) to `api_keys` with FK to `agents`
  - Added `agent_id` (nullable) to `traces` with FK to `agents`
  - Seeded "Default" agent per existing tenant before setting api_keys.agent_id NOT NULL
  - Down migration reverses in strict FK dependency order
- **Key Decisions:**
  - `agents.merge_policies` NOT NULL with application-level default
  - Seed "Default" agent for every existing tenant
  - `api_keys.agent_id` is NOT NULL (DB-enforced)
  - `traces.agent_id` is nullable (preserves historical data)
  - `tenants.parent_id` uses ON DELETE CASCADE

### 2. Portal Routes for Subtenants + Agents
- **Files:** `src/routes/portal.ts`
- **New Endpoints:**
  - `POST /v1/portal/subtenants` — Create subtenant with owner membership (transactional)
  - `GET /v1/portal/subtenants` — List subtenants
  - `GET /v1/portal/agents` — List agents in current tenant
  - `POST /v1/portal/agents` — Create agent with optional provider_config
  - `GET /v1/portal/agents/:id` — Get agent details (membership-gated)
  - `PUT /v1/portal/agents/:id` — Update agent fields (dynamic SET builder)
  - `GET /v1/portal/agents/:id/resolved` — Get agent config with inherited values applied
  - `DELETE /v1/portal/agents/:id` — Soft-delete agent (sets deleted_at)
  - Extended `GET /v1/portal/me` with agents + subtenants in response
- **Key Decisions:**
  - Agent membership gated via JOIN on `tenant_memberships`
  - `provider_config` encrypted on write, sanitized on read (same pattern as tenant settings)
  - Resolved config uses JS-layer inheritance (agent → tenant → parent chain)
  - PUT uses dynamic SET clause builder for partial updates

### 3. Analytics Rollup with Recursive CTE
- **File:** `src/analytics.ts`
- **Changes:**
  - Added `rollup?: boolean` parameter to three functions:
    - `getAnalyticsSummary(tenantId, windowHours, rollup)`
    - `getTimeseriesMetrics(tenantId, windowHours, bucketMinutes, rollup)`
    - `getModelBreakdown(tenantId, windowHours, limit, rollup)`
  - When `rollup = true`, prepend `WITH RECURSIVE subtenant_tree` CTE
  - CTE walks `tenants.parent_id` to collect all descendant tenant IDs
  - Traces queried from aggregated subtenant tree, not single tenant
- **Key Decisions:**
  - CTE restricted to `tenants` table only (preserves partition pruning on `traces`)
  - Backward compatible (rollup defaults to `false`)
  - Admin functions unchanged

### 4. Gateway Agent-Aware Config Resolution + Injection
- **Files:** `src/gateway.ts`, `src/agent.ts` (new)
- **Changes:**
  - Two-query lookup: api_keys → agents → immediate tenant, then separate recursive CTE for parent chain
  - Chain resolution in TypeScript: `.find(non-null)` for providerConfig/systemPrompt, union+dedup for skills/mcpEndpoints
  - Provider cache keyed by `agentId` (fallback to `tenantId`); reverse index allows `evictProvider(tenantId)` without API change
  - `applyAgentToRequest()` applies merge policies to outbound request before provider
  - `handleMcpRoundTrip()` on non-streaming responses only
  - `agentId` recorded on every trace (nullable for backward compatibility)
- **Key Decisions:**
  - Two-query pattern (not one CTE) for readability
  - Merge policies applied at request-time in gateway
  - MCP tool calls on non-streaming only (Phase 2 can add streaming)
  - Cache invalidation preserves existing admin route API

## Testing

- Smoke tests updated (see Hockney's batch)
- All new routes return correct response shapes
- Inheritance chain tested (agent → tenant → parent)
- API key binding to agents verified

## Commit

Committed: `63f2029` — "feat: subtenant hierarchy, agents, and project-scoped API keys"

---

## Learnings for Team

- **Self-FK cascades:** ON DELETE CASCADE on `tenants.parent_id` ensures clean subtenant deletion
- **Encryption consistency:** Agent `provider_config` follows exact same encrypt-on-write / sanitize-on-read pattern as tenant settings
- **CTE partition pruning:** Keep recursion on non-partitioned tables only; reference result set in WHERE subquery
- **Mixed inheritance semantics:** First-non-null vs. union operations are cleaner in JS than monolithic SQL
- **Two-query pattern:** Separates concerns; parent chain query skipped entirely for common case (no parent)
